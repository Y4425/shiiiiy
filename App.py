import streamlit as st
import pandas as pd
import numpy as np
import hashlib
import random

st.set_page_config(
    page_title="ë°ì´í„° ìµëª…ì²˜ë¦¬ Â· ë™í˜•ì•”í˜¸ ì‹¤ìŠµ",
    layout="centered"
)

st.title("ğŸ§¬ ë°ì´í„° ê°€ëª…ì²˜ë¦¬ Â· ìµëª…ì²˜ë¦¬ Â· ë™í˜•ì•”í˜¸ ì‹¤ìŠµ ì•±")
st.caption(
    "ì½”ë”© ë™ì•„ë¦¬ í”„ë¡œì íŠ¸ìš© Â· ê°œì¸ì •ë³´ ë³´í˜¸ ê¸°ìˆ (ê°€ëª…ì²˜ë¦¬, ìµëª…í™”, ë™í˜•ì•”í˜¸ ê°œë…)ì„ "
    "ì§ì ‘ ëˆˆìœ¼ë¡œ í™•ì¸í•´ ë³¼ ìˆ˜ ìˆëŠ” êµìœ¡ìš© ì›¹ì•±ì…ë‹ˆë‹¤."
)

tab1, tab2, tab3 = st.tabs(["1ï¸âƒ£ ê°€ëª…ì²˜ë¦¬", "2ï¸âƒ£ ìµëª…Â·ë¹„ì‹ë³„í™”", "3ï¸âƒ£ ë™í˜•ì•”í˜¸(ê°œë… ì‹¤ìŠµ)"])

# -------------------------------------------------
# 1. ê°€ëª…ì²˜ë¦¬ íƒ­
# -------------------------------------------------
with tab1:
    st.subheader("1ï¸âƒ£ ê°€ëª…ì²˜ë¦¬ (Pseudonymization) ì‹¤ìŠµ")

    st.markdown(
        """
        **ê°€ëª…ì²˜ë¦¬**ë€, ì§ì ‘ì ì¸ ì‹ë³„ì(ì´ë¦„, ì£¼ë¯¼ë²ˆí˜¸ ë“±)ë¥¼ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ ì¹˜í™˜í•´ì„œ  
        ì›ë˜ ëˆ„êµ¬ì˜€ëŠ”ì§€ ì‰½ê²Œ ì•Œ ìˆ˜ ì—†ê²Œ ë§Œë“œëŠ” ë°©ë²•ì…ë‹ˆë‹¤.  
        (ì˜ˆ: ì´ë¦„ â†’ ë¬´ì‘ìœ„ ID, ì£¼ë¯¼ë²ˆí˜¸ â†’ í•´ì‹œê°’ ë“±)
        """
    )

    col1, col2 = st.columns(2)
    with col1:
        name = st.text_input("ì´ë¦„ ì…ë ¥", value="í™ê¸¸ë™")
        rrn = st.text_input("ì£¼ë¯¼ë²ˆí˜¸(ì˜ˆì‹œ)", value="000101-3123456")
        phone = st.text_input("ì „í™”ë²ˆí˜¸(ì˜ˆì‹œ)", value="010-1234-5678")
    with col2:
        salt = st.text_input("ê°€ëª… ID ìƒì„±ì„ ìœ„í•œ ë¹„ë°€í‚¤(salt)", value="my_secret_key")

    def mask_name(n):
        if len(n) <= 1:
            return "*"
        return n[0] + "*" * (len(n) - 1)

    def mask_rrn(r):
        if len(r) >= 8:
            return r[:8] + "******"
        return r

    def mask_phone(p):
        if "-" in p:
            parts = p.split("-")
            if len(parts) == 3:
                return f"{parts[0]}-****-{parts[2]}"
        if len(p) > 4:
            return "*" * (len(p) - 4) + p[-4:]
        return p

    def make_pseudo_id(text, salt=""):
        base = (text + salt).encode("utf-8")
        return hashlib.sha256(base).hexdigest()

    if st.button("ê°€ëª…ì²˜ë¦¬ ì‹¤í–‰"):
        masked_name = mask_name(name)
        masked_rrn = mask_rrn(rrn)
        masked_phone = mask_phone(phone)   # â˜… ì—¬ê¸° ë°˜ë“œì‹œ phone ë³€ìˆ˜!

        pseudo_id = make_pseudo_id(rrn + phone, salt)

        result_df = pd.DataFrame(
            {
                "í•­ëª©": ["ì´ë¦„", "ì£¼ë¯¼ë²ˆí˜¸", "ì „í™”ë²ˆí˜¸", "ê°€ëª… ID(í•´ì‹œ)"],
                "ì›ë³¸ ê°’": [name, rrn, phone, "(í•´ì‹œë¡œë§Œ ì €ì¥)"],
                "ê°€ëª…/ë§ˆìŠ¤í‚¹ ê²°ê³¼": [masked_name, masked_rrn, masked_phone, pseudo_id[:16] + "..."],
            }
        )

        st.success("ê°€ëª…ì²˜ë¦¬ ê²°ê³¼ì…ë‹ˆë‹¤.")
        st.dataframe(result_df, use_container_width=True)

        st.info(
            "â€» ì‹¤ì œ ì‹œìŠ¤í…œì—ì„œëŠ” ì›ë³¸ ì£¼ë¯¼ë²ˆí˜¸ë‚˜ ì „í™”ë²ˆí˜¸ë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ì§€ ì•Šê³ , "
            "ì´ëŸ° í•´ì‹œê°’(ê°€ëª… ID)ë§Œ ì €ì¥í•´ì„œ ê°œì¸ì •ë³´ ìœ ì¶œ ìœ„í—˜ì„ ì¤„ì…ë‹ˆë‹¤."
        )

# -------------------------------------------------
# 2. ìµëª…Â·ë¹„ì‹ë³„í™” íƒ­ (k-ìµëª…ì„± ì§ê´€)
# -------------------------------------------------
with tab2:
    st.subheader("2ï¸âƒ£ ìµëª…Â·ë¹„ì‹ë³„í™” (k-ìµëª…ì„± ì§ê´€) ì‹¤ìŠµ")

    st.markdown(
        """
        **ìµëª…ì²˜ë¦¬(ë¹„ì‹ë³„í™”)**ëŠ”, ë°ì´í„°ë¥¼ ë¶„ì„ì—ëŠ” ì“¸ ìˆ˜ ìˆì§€ë§Œ  
        ê°œë³„ ê°œì¸ì„ ì•Œì•„ë³´ê¸°ëŠ” ì–´ë µë„ë¡ ì •ë³´ë¥¼ ì¼ë°˜í™”í•˜ê±°ë‚˜ ì‚­ì œí•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.  

        ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ ì˜ˆì‹œ ë°ì´í„°(ë‚˜ì´, ìš°í¸ë²ˆí˜¸, ì§ˆë³‘)ë¥¼ ê°€ì§€ê³   
        ë‚˜ì´ êµ¬ê°„ê³¼ ìš°í¸ë²ˆí˜¸ ìë¦¿ìˆ˜ë¥¼ ì¡°ì ˆí•˜ë©´ì„œ  
        ê° ê·¸ë£¹ì— ëª‡ ëª…ì´ í¬í•¨ë˜ëŠ”ì§€(=kê°’)ë¥¼ í™•ì¸í•´ ë´…ë‹ˆë‹¤.
        """
    )

    raw_data = pd.DataFrame(
        {
            "ë‚˜ì´": [23, 25, 27, 34, 36, 42, 44, 52, 55, 60],
            "ìš°í¸ë²ˆí˜¸": ["12345", "12340", "12347", "12390", "12410",
                      "12500", "12503", "12780", "12782", "12900"],
            "ì§ˆë³‘": ["ê°ê¸°", "ë…ê°", "ìš°ìš¸ì¦", "ê°ê¸°", "ë‹¹ë‡¨",
                    "ê³ í˜ˆì••", "ê°ê¸°", "ìš°ìš¸ì¦", "ê°ê¸°", "ì•”"]
        }
    )

    st.write("ğŸ” **ì›ë³¸ ë°ì´í„°(ì˜ˆì‹œ)**")
    st.dataframe(raw_data, use_container_width=True)

    st.markdown("---")

    st.write("### ìµëª…í™” ì„¤ì •")

    age_group_size = st.slider("ë‚˜ì´ êµ¬ê°„ í¬ê¸° (ì˜ˆ: 5ì‚´ ë‹¨ìœ„, 10ì‚´ ë‹¨ìœ„)", min_value=5, max_value=20, value=10, step=5)
    zip_keep = st.slider("ìš°í¸ë²ˆí˜¸ ì•ì—ì„œë¶€í„° ë³´ì¡´í•  ìë¦¬ ìˆ˜", min_value=1, max_value=5, value=3)

    def generalize_age(age, group_size):
        base = (age // group_size) * group_size
        return f"{base}~{base + group_size - 1}"

    def generalize_zip(zipcode, keep):
        if len(zipcode) <= keep:
            return zipcode
        return zipcode[:keep] + "*" * (len(zipcode) - keep)

    anon_df = raw_data.copy()
    anon_df["ë‚˜ì´_êµ¬ê°„"] = anon_df["ë‚˜ì´"].apply(lambda x: generalize_age(x, age_group_size))
    anon_df["ìš°í¸ë²ˆí˜¸_ì¼ë°˜í™”"] = anon_df["ìš°í¸ë²ˆí˜¸"].apply(lambda x: generalize_zip(x, zip_keep))

    grouping_cols = ["ë‚˜ì´_êµ¬ê°„", "ìš°í¸ë²ˆí˜¸_ì¼ë°˜í™”"]
    group_counts = (
        anon_df.groupby(grouping_cols)
        .size()
        .reset_index(name="ê·¸ë£¹_ì¸ì›ìˆ˜(k)")
    )

    anon_df = anon_df.merge(group_counts, on=grouping_cols, how="left")

    st.write("### ìµëª…í™”(ì¼ë°˜í™”) ê²°ê³¼")
    st.dataframe(
        anon_df[["ë‚˜ì´_êµ¬ê°„", "ìš°í¸ë²ˆí˜¸_ì¼ë°˜í™”", "ì§ˆë³‘", "ê·¸ë£¹_ì¸ì›ìˆ˜(k)"]],
        use_container_width=True
    )

    min_k = int(anon_df["ê·¸ë£¹_ì¸ì›ìˆ˜(k)"].min())
    st.success(f"í˜„ì¬ ì„¤ì •ì—ì„œ **ìµœì†Œ k ê°’ = {min_k}** ì…ë‹ˆë‹¤.")

    if min_k < 3:
        st.warning(
            "âš  ì¼ë¶€ ê·¸ë£¹ì˜ ì¸ì› ìˆ˜(k)ê°€ 3 ë¯¸ë§Œì´ë¼, í•´ë‹¹ ê·¸ë£¹ì— ì†í•œ ì‚¬ëŒì€ ë‹¤ì‹œ ì‹ë³„ë  ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.\n"
            "â†’ ë‚˜ì´ êµ¬ê°„ì„ ë” í¬ê²Œ í•˜ê±°ë‚˜, ìš°í¸ë²ˆí˜¸ë¥¼ ë” ì§§ê²Œ í‘œì‹œí•´ì„œ kë¥¼ í‚¤ì›Œ ë³´ì„¸ìš”."
        )
    else:
        st.info(
            "âœ… ëª¨ë“  ê·¸ë£¹ì˜ ì¸ì› ìˆ˜(k)ê°€ 3 ì´ìƒì´ë¯€ë¡œ, ì´ ì˜ˆì‹œì—ì„œëŠ” ì¬ì‹ë³„ ìœ„í—˜ì´ ìƒëŒ€ì ìœ¼ë¡œ ì¤„ì–´ë“  ìƒíƒœì…ë‹ˆë‹¤."
        )

# -------------------------------------------------
# 3. ë™í˜•ì•”í˜¸(ê°œë… ì‹¤ìŠµ) íƒ­
# -------------------------------------------------
with tab3:
    st.subheader("3ï¸âƒ£ ë™í˜•ì•”í˜¸ ê°œë… ì‹¤ìŠµ (ì¥ë‚œê° ì˜ˆì‹œ)")

    st.markdown(
        """
        **ë™í˜•ì•”í˜¸(Homomorphic Encryption)**ëŠ”  
        ğŸ” **ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•œ ìƒíƒœ ê·¸ëŒ€ë¡œ** ì—°ì‚°(ë”í•˜ê¸°, ê³±í•˜ê¸° ë“±)ì„ í•  ìˆ˜ ìˆê²Œ í•´ ì£¼ëŠ” ì•”í˜¸ì…ë‹ˆë‹¤.
        """
    )

    st.markdown("### 1) í‚¤ì™€ í‰ë¬¸ ì„¤ì •")

    key = st.slider("ì•”í˜¸ í‚¤ K (ë„ˆë¬´ ì‘ì§€ ì•Šê²Œ ì„¤ì •)", min_value=50, max_value=300, value=101, step=1)
    m1 = st.number_input("ì²« ë²ˆì§¸ í‰ë¬¸ ê°’ m1", min_value=0, max_value=20, value=5, step=1)
    m2 = st.number_input("ë‘ ë²ˆì§¸ í‰ë¬¸ ê°’ m2", min_value=0, max_value=20, value=7, step=1)

    st.caption("â€» ì¡°ê±´: ë‘ í‰ë¬¸ í•© m1 + m2 < K ë²”ìœ„ ì•ˆì— ìˆì–´ì•¼ ì œëŒ€ë¡œ ë™ì‘í•©ë‹ˆë‹¤.")

    if st.button("ë™í˜•ì•”í˜¸(ì¥ë‚œê°) ì—°ì‚° ì‹œë®¬ë ˆì´ì…˜"):
        r1 = random.randint(1, 10)
        r2 = random.randint(1, 10)

        C1 = m1 + r1 * key
        C2 = m2 + r2 * key

        C_sum = C1 + C2

        m1_dec = C1 % key
        m2_dec = C2 % key
        m_sum_dec = C_sum % key

        st.write("#### (1) ê°œë³„ ì•”í˜¸ë¬¸")
        st.code(
            f"""
í‚¤ K = {key}

í‰ë¬¸ m1 = {m1}
ëœë¤ r1 = {r1}
ì•”í˜¸ë¬¸ C1 = m1 + r1*K = {C1}

í‰ë¬¸ m2 = {m2}
ëœë¤ r2 = {r2}
ì•”í˜¸ë¬¸ C2 = m2 + r2*K = {C2}
""",
            language="text",
        )

        st.write("#### (2) ì„œë²„ì—ì„œ í•˜ëŠ” ì¼ (ì•”í˜¸ë¬¸ ë§ì…ˆë§Œ)")
        st.code(
            f"""
ì„œë²„ëŠ” í‰ë¬¸ì„ ëª¨ë¥¸ ì±„ë¡œ, ì•”í˜¸ë¬¸ë“¤ë§Œ ë”í•©ë‹ˆë‹¤.

C_sum = C1 + C2 = {C_sum}
""",
            language="text",
        )

        st.write("#### (3) ë³µí˜¸í™” ê²°ê³¼ (C mod K)")
        st.code(
            f"""
ë³µí˜¸í™”(ì˜ˆì‹œ):

C1 mod K = {C1} mod {key} = {m1_dec}   (ì›ë˜ m1 = {m1})
C2 mod K = {C2} mod {key} = {m2_dec}   (ì›ë˜ m2 = {m2})

C_sum mod K = {C_sum} mod {key} = {m_sum_dec}
ì›ë˜ m1 + m2 = {m1} + {m2} = {m1 + m2}
""",
            language="text",
        )

        if m1 + m2 == m_sum_dec:
            st.success("âœ… ì•”í˜¸ ìƒíƒœì—ì„œ ë”í•œ ë’¤ ë³µí˜¸í™”í•´ë„, í‰ë¬¸ ë§ì…ˆ ê²°ê³¼ì™€ ì¼ì¹˜í•©ë‹ˆë‹¤!")
        else:
            st.warning(
                "â— m1 + m2 â‰¥ K ì´ë¼ì„œ, ì´ ë‹¨ìˆœí•œ ì¥ë‚œê° ì˜ˆì‹œì—ì„œëŠ” ê²°ê³¼ê°€ ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
                "â†’ Kë¥¼ ë” í¬ê²Œ ì„¤ì •í•´ ë³´ì„¸ìš”."
            )

        st.info(
            "ì´ ì˜ˆì‹œëŠ” ë³´ì•ˆì ìœ¼ë¡œ ì•ˆì „í•œ ì•”í˜¸ê°€ ì•„ë‹ˆë¼, "
            "â€˜ì•”í˜¸ ìƒíƒœì—ì„œ ì—°ì‚°ì´ ê°€ëŠ¥í•˜ë‹¤â€™ëŠ” ë™í˜•ì•”í˜¸ì˜ ê°œë…ì„ ìˆ˜í•™ì ìœ¼ë¡œ ë§›ë³´ëŠ” êµìœ¡ìš© ëª¨ë¸ì…ë‹ˆë‹¤.\n"
            "ì‹¤ì œ ë™í˜•ì•”í˜¸(FHE, HE)ëŠ” í›¨ì”¬ ë³µì¡í•œ ìˆ˜í•™ê³¼ í° ìˆ˜ ì—°ì‚°ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
        )
